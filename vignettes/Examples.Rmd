---
title: "Examples"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 8
)
```

```{r setup, echo=FALSE}
library(sugarglider)
library(knitr)
library(ggplot2)
library(sf)
library(tidyverse)
library(grid)
library(viridis)
library(gridExtra)
library(ozmaps)
library(ggthemes)
library(kableExtra)
library(usmap)
library(ggiraph)
library(leaflet)
```
  
## Overview

`sugarglider` provides ggplot2 extensions to create glyph maps that visualize multivariate spatio-temporal data with `geom_glyph_ribbon()` and `geom_glyph_segment()`.

These functions create a ribbon geometry designed to display glyphs based on the combination of `x_major` and `y_major`. For each `x_minor` value, `geom_glyph_ribbon()` displays a y interval defined by `ymin_minor` and `ymax_minor`. Meanwhile, `geom_glyph_segment()` draw a straight line between `y_minor` and `yend_minor` with respect to `x_minor`.

Let's compare `geom_glyph_ribbon()` and `geom_glyph_segment()`:

```{r, fig.height=6}
vic_temp <- aus_temp |>
  filter(id %in% c("ASN00026021", "ASN00085291", "ASN00084143"))

# Define a color palette
color_palette <- c("deepskyblue4", "coral3")

p1 <- vic_temp |>
   ggplot(aes(x_major = long,
              y_major = lat,
              x_minor = month,
              ymin_minor = tmin,
              ymax_minor = tmax)) +
  geom_sf(data = abs_ste |> filter(NAME == "Victoria"),
          fill = "antiquewhite", color = "white", inherit.aes = FALSE)  +
  # Customize the size of each glyph box using the width and height parameters.
  add_glyph_boxes(color = color_palette[1]) +
  add_ref_lines(color = color_palette[1]) +
  geom_glyph_ribbon(color = color_palette[1], fill = color_palette[1]) +
  # Theme and aesthetic
  theme_glyph() +
  labs(title = "geom_glyph_ribbon()") +
  theme(plot.title = element_text(hjust = 0.5),
        title = element_text(color = color_palette[1],
                             family  = "mono")) 

p2 <- vic_temp |>
   ggplot(aes(x_major = long,
              y_major = lat,
              x_minor = month,
              y_minor = tmin,
              yend_minor = tmax)) +
  geom_sf(data = abs_ste |> filter(NAME == "Victoria"),
         fill = "antiquewhite", color = "white", inherit.aes = FALSE)  +
  # Customize the size of each glyph box using the width and height parameters.
  add_glyph_boxes(color = color_palette[2]) +
  add_ref_lines(color = color_palette[2]) +
  geom_glyph_segment(color = color_palette[2]) +
  # Theme and aesthetic
  theme_glyph() +
  labs(title = "geom_glyph_segment()") +
  theme(plot.title = element_text(hjust = 0.5),
        title = element_text(color = color_palette[2]))

grid.arrange(p1, p2, ncol = 2) 

```

## Options

Options allow you to modify the behavior of `sugarglider` to fit the specific needs of your figure. These are all global options that affect every glyph.

|Option          | Default      | Description
|--------------- | ------------ | ------------------------------------------------
| `x_scale`         | `"identity"`         | This function scales each set of minor values within a grid cell along the x-dimension.
|`y_scale`      | `"identity"`          | This function scales each set of minor values within a grid cell along the y-dimension.
|`width`         | `default`          |  The width of each glyph. The `default` is set to the smallest distance between two consecutive coordinates, converted from meters to degrees of latitude using the Haversine method.
|`height`     | `default`     | The height of each glyph. The `default` is calculated using the ratio (1:1.618) relative to the `width`, to maintain a consistent aspect ratio.
|`global_rescale`      | `TRUE`        | Determines whether rescaling is applied globally across all glyphs or individually for each glyph

## Aesthetics

`sugarglider` provides the same aesthetics for `geom_glyph_ribbon()` and `geom_glyph_segment()` as those available in `geom_ribbon()` or `geom_segment()`, while also introducing additional unique options.

|Option          | Default      | Description
|--------------- | ------------ | ------------------------------------------------
| `colour`         | `"black"`         | Color for line segments and borders.
|`linewidth`      | `0.5`          | Width of the line for borders.
|`linetype`         | `1`          |  Style of the line for borders.
|`fill`     | `"black"`     | Color of the interior area of the geometries.
|`alpha`      | `0.8`        | Transparency level of the glyphs. 

## Interactivity

Interactive graphics can be useful when working with spatio-temporal data since they allow for exploring the data from multiple perspective. In [cubble](https://huizezhang-sherry.github.io/cubble/articles/cb6interactive.html) package, they demonstrate this by creating a linked interactive plot using `crosswalk::bscols()` . In this vignette, we will demonstrate how to generate how to generate interactive glyph maps with leaftlet and ggiraph. 

### Creating glyph maps with leaflet

The dataset used in this example is `aus_temp` which includes key climate variables, such as precipitation and temperature, recorded at 29 different weather stations throughout 2020. To generate PNG of each glyph, we first need to generate a list of all unique weather station. We then interate over all weather station and generate ribbon glyphs using `geom_glyph_ribbon()`, `add_glyph_boxes()` and `add_ref_lines()`. Each glpyh are saved into png format, and the file path of all the pngs are saved as an object for the next step. 

```{r}
# Generate a list of unique weather stations
df_id <- aus_temp$id |> unique()

# Generate PNG of all the ribbon glyph
purrr::map(1:length(df_id), function(i) {
  dt <- aus_temp |> filter(id == df_id[i])
  p <- dt |> ggplot(aes(x_major = long, y_major = lat,
                   x_minor = month, ymin_minor = tmin,
                   ymax_minor = tmax)) +
    add_glyph_boxes(color = "#FFAD60", 
                    fill = "#FFEEAD", alpha = 0.5,
                    linewidth = 1) +
    add_ref_lines(color = "#FFAD60", alpha = 1,
                  linewidth = 1) +
    geom_glyph_ribbon(color = "#A66E38", fill = "#A66E38") +
    theme_void() 
  
  file_path <- paste0("../man/figures/glyph_", df_id[i], ".png")
  ggsave(file_path, plot = p, width = 3, height = 2, units = "in", dpi = 300,
         path = "../man/figures", bg = "transparent")
  return(file_path)

  }) -> glyph_png 

```

To create the base map for leaflet, we use the function `leaflet()` and `addProviderTiles()` with [CartoDB.Positron](https://github.com/CartoDB/basemap-styles) as provider for the light, grey map aesthetic. 

```{r}
# Create a leaflet map 
leaflet_map <- leaflet() |>
  addProviderTiles("CartoDB.Positron")
```

Next is to iterate through all the PNG files and convert them into icons using `makeIcon()`. Here user can control the dimension of each icon by modifying the iconWidth and iconHeight arguments. The final step is to add each icon onto the leaflet map using `addMarkers`. Within options argument of `addMarkers`, user can finetune each glyphs such in this case is the opacity level. With label arugment allow user to specify the information they wishes to display with the hover over effect, which in this example is set to ID. 

```{r}
# Loop through the PNG files and add them to the map
for (i in seq_along(glyph_png)) {
  icon <- makeIcon(iconUrl = glyph_png[i], iconWidth = 100, iconHeight = 60)

  dt <- aus_temp |> filter(id == df_id[i])
  leaflet_map <- leaflet_map |>
    addMarkers(lng = dt$long[1], lat = dt$lat[1], icon = icon,
               label = dt$id, options = markerOptions(opacity = 0.1))
}

leaflet_map
```

### Interative glyph maps with ggiraph

User can generate interactive glyphs with `ggiraph::girafe` using sugarglider. To start, user need to specify tooltips which is the information that will be displayed when hover over. In this example, the tooltips consist of station id, month, minimum and maximum temperature across all month. 

```{r}

vic_nsw <- aus_temp |>
  filter(id %in% c("ASN00026021", "ASN00085291", "ASN00084143",
                   "ASN00055325", "ASN00049000"))


# Specify tooltip for ggiraph 
vic_nsw <- vic_nsw |>
  mutate(tooltip = paste("Station ID: ", id,
                         "\nmonth: ", month,
                         "\nmin-temp: ", round(tmin,2),
                         "\nmax-temp: ", round(tmax,2)))
```

Tooltips needs to be provided in the asethetic to in the `tooltip` argument. User can then plot their desired glyph map and save it as a ggplot object. This ggplot object is then converted into girafe object using the `girafe()` function. 

```{r}
temp <- vic_nsw |> 
  ggplot(aes(x_major = long, y_major = lat,
             x_minor = month, y_minor = tmin,
             yend_minor = tmax,
             tooltip = tooltip)) + 
  geom_sf(data = abs_ste |> filter(NAME %in% c("New South Wales", "Victoria")),
          color = "white",
          fill = "antiquewhite", inherit.aes = FALSE) +
  add_glyph_boxes(color = "#CD5C08") +
  add_ref_lines(color = "#CD5C08") +
  geom_glyph_segment(color = "#CD5C08") +
  coord_sf(xlim = c(140,153)) +
  labs(title = "Daily Temperature Variation Across Victoria and New South Wales") +
  theme_glyph() 

# Interactive plot using ggiraph
girafe(ggobj = temp)
```


## Examples

### Monthly temperature across Australia 

The National Oceanic and Atmospheric Administration (NOAA) provides comprehensive weather data from numerous stations across Australia. The `aus_temp` dataset includes key climate variables, such as precipitation and temperature, recorded at 29 different weather stations throughout 2020.

```{r}
head(aus_temp) |>
  kable() |> kable_styling()
```

Using the default rescaling parameters, we can visualize the temperature data through `geom_glyph_segment()`, alongside `geom_point()` elements that mark the location of each weather station. Each segment glyph represents local climate data, offering an intuitive way to explore temperature variations across Australia.

The default `identity` scaling function is applied to each set of minor values within a grid cell. This method centers the glyphs both vertically and horizontally based on the station's coordinates and adjusts the minor axes to fit within the interval [-1, 1]. This ensures that the glyphs are appropriately sized to fit the desired dimensions. In this example, we wil also be specifying the size of the glyph by specifying the size of the width and height of the glyph. 

```{r}
aus_temp |>
  ggplot(aes(
    x_major = long, 
    y_major = lat, 
    x_minor = month, 
    y_minor = tmin, 
    yend_minor = tmax)) +
  geom_sf(data = abs_ste, fill = "antiquewhite",
          inherit.aes = FALSE, color = "white") +
  coord_sf(xlim = c(110,155)) +
  # Add glyph box to each glyph
  add_glyph_boxes( width = 3, height = 2) +
  # Add points for weather station 
  geom_point(aes(x = long, y = lat,
                 color = "Weather Station")) +
  # Customize the size of each glyph box using the width and height parameters.
  geom_glyph_segment(
    width = 3, height = 2,
    aes(color = "Temperature")) +
  # Theme and aesthetic 
  scale_color_manual(
    values = c("Weather Station" = "firebrick",
               "Temperature" = "black")) +
  labs(color = "Data",
       title = "Daily Temperature Variations Across Australian Weather Stations")  +
  theme_glyph()

```

So far, all the visualizations have used global rescaling (enabled by default), meaning the glyphs are sized relative to one another based on their data values. By disabling global rescaling, we can see the effects of local rescaling, where each glyph is resized based on its individual values. 

- **Local Rescale (global_rescale = FALSE)**: Each line segment's length is determined by the local temperature range within a region, emphasizing regional differences in temperature patterns. 
- **Global Rescale (global_rescale = TRUE)**: Global temperature range determined the length of each line segment, ensuring that data range remain consistent across all region for easy comparison.

Below is a comparison of the two rescaling approaches. In this example, we also specify the size of the glyphs by setting width = 3 and height = 2. 

```{r, fig.height = 6}
# Global rescale
p1 <- aus_temp |>
  ggplot(aes(
    x_major = long, 
    y_major = lat, 
    x_minor = month, 
    y_minor = tmin, 
    yend_minor = tmax)) +
  geom_sf(data = abs_ste, fill = "antiquewhite",
          inherit.aes = FALSE, color = "white") +
  coord_sf(xlim = c(110,155)) +
  # Add glyph box to each glyph
  add_glyph_boxes(width = 3, height = 2) +
  # Add reference lines to each glyph
  add_ref_lines(width = 3, height = 2) +
  # Glyph segment plot with global rescale
  geom_glyph_segment(global_rescale = TRUE,
                     width = 3, height = 2) +
  labs(title = "Global Rescale") +
  theme_glyph()
  
# Local Rescale
p2 <- aus_temp |>
  ggplot(aes(
    x_major = long, 
    y_major = lat, 
    x_minor = month, 
    y_minor = tmin, 
    yend_minor = tmax)) +
  geom_sf(data = abs_ste, fill = "antiquewhite",
          inherit.aes = FALSE, color = "white") +
  coord_sf(xlim = c(110,155)) +
  # Add glyph box to each glyph
  add_glyph_boxes(width = 3, height = 2) +
  # Add reference lines to each glyph
  add_ref_lines(width = 3, height = 2) +
  # Glyph segment plot with local rescale
  geom_glyph_segment(global_rescale = FALSE,
                     width = 3, height = 2) +
  labs(title = "Local Rescale") +
  theme_glyph()

grid.arrange(p1, p2, ncol = 2) 
```

#### Highlighting Temperature Changes with Color-Coded Glyph

Expanding on our temperature analysis, we now incorporate precipitation data across Australia using `geom_glyph_ribbon()`. The glyphs are color-coded to represent varying levels of rainfall, with reference lines and glyph boxes enhancing clarity and allow for easy comparison of precipitation level across the country.

```{r}
prcp <- aus_temp |>
   group_by(id) |>
   mutate(prcp = mean(prcp, na.rm = TRUE)) |>
   ggplot(aes(x_major = long, y_major = lat,
              x_minor = month, ymin_minor = tmin,
              ymax_minor = tmax, 
              fill = prcp, color = prcp)) +
  geom_sf(data = abs_ste, fill = "antiquewhite",
          inherit.aes = FALSE, color = "white") +
  # Add glyph box to each glyph
   add_glyph_boxes() +
  # Add ref line to each glyph
   add_ref_lines() +
  # Add glyph ribbon plots
   geom_glyph_ribbon() +
   coord_sf(xlim = c(112,155)) +
  # Theme and aesthetic 
  theme_glyph() +
  scale_fill_gradientn(colors = c("#ADD8E6", "#2b5e82", "dodgerblue4")) +
  scale_color_gradientn(colors = c( "#ADD8E6", "#2b5e82", "dodgerblue4")) +
  labs(fill = "Percepitation", color = "Percepitation",
       title = "Precipitation and Temperature Ranges Across Australia") 

prcp
```

If you're interested in comparing temperature trends across different years for specific regions in Victoria, `geom_glyph_ribbon()` provides a way to visualize how temperatures have evolved over time, with each year distinguished by a different color for clarity. 

```{r}

fact <- historical_temp |> 
  filter(id %in% c("ASN00026021", "ASN00085291", "ASN00084143")) |>
   ggplot(aes(color = factor(year), fill = factor(year),
              group = interaction(year,id),
              x_major = long, y_major = lat,
              x_minor = month, ymin_minor = tmin, 
              ymax_minor = tmax)) +
  geom_sf(data = abs_ste |> filter(NAME == "Victoria"),
           fill = "antiquewhite", color = "white",
          inherit.aes = FALSE)  +
  # Customized the dimension of each glyph with `width` and `height` parameters
   add_glyph_boxes(width = rel(2),
                   height = rel(1.5)) +
   add_ref_lines(width = rel(2),
                 height = rel(1.5)) +
   geom_glyph_ribbon(alpha = 0.5,
                     width = rel(2),
                     height = rel(1.5)) +
  labs(x = "Longitude", y = "Latitude",
       color = "year", fill = "year",
       title = "Temperature Trends in Selected Victorian Weather Stations") +
  # Theme and aesthetic
  theme_glyph() +
  theme(legend.position.inside = c(.4,0)) +
  scale_colour_wsj("colors6") +
  scale_fill_wsj("colors6") 

fact
```

#### Integrating Glyph Legends

To further enhance map readability, the `add_geom_legend()` function integrates a larger version of one of the glyphs into the bottom left corner of the plot. This legend helps users interpret the scale of the data. 

In the example below, a series of glyph are created using `geom_glyph_ribbon()` and overlaid on a basemap to depict daily temperature variations across Australian weather stations. A legend is added through `add_glyph_legend()`, allowing users to easily interpret the range of daily temperature value based on a randomly selected weather station. Since the legend data is drawn from a single, randomly chosen station, it's important for users to set a seed for reproducibility to ensure consistent results.

```{r, fig.height=6}
set.seed(28493)
legend <- aus_temp |>
   ggplot(aes(x_major = long, y_major = lat,
              x_minor = month, ymin_minor = tmin,
              ymax_minor = tmax)) +
  geom_sf(data = abs_ste, fill = "antiquewhite",
          inherit.aes = FALSE, color = "white") +
  add_glyph_boxes(color = "#227B94") +
  add_ref_lines(color = "#227B94") +
  add_glyph_legend(color = "#227B94", fill = "#227B94") +
  # Add a ribbon legend
  geom_glyph_ribbon(color = "#227B94", fill = "#227B94") +
  theme_glyph() +
  labs(title = "Temperature Ranges Across Australia with Glyph Legend") 

legend
```

#### Observations and Insights

Both the Geom Glyph Segment and Geom Glyph Ribbon provide valuable insights into seasonal temperature trends across Australia. Disabling global rescaling reveals that most weather stations follow similar curvature trends relative to their neighboring stations. However, with global rescaling enabled, it becomes apparent that coastal regions exhibit far less temperature variation overall.

### Flight Variability at U.S. Airports with the Most Cancellations

The U.S. Department of Transportation (DOT) Bureau of Transportation Statistics monitors the on-time performance of domestic flights operated by major U.S. airlines. Each month, the DOT publishes the Air Travel Consumer Report, which provides a summary of on-time, delayed, canceled, and diverted flights.

This dataset, sourced from the Kaggle [Airline Flight Delay and Cancellation](https://www.kaggle.com/datasets/patrickzel/flight-delay-and-cancellation-dataset-2019-2023) data, has been processed and aggregated to show the minimum and maximum number of flights originating from the top 10 U.S. airports with the highest cancellation rates. 

```{r}
head(flights) |>
  kable() |> kable_styling()
```

In this section of the analysis, we will showcase the functionality of `geom_glyph_segment()` the monthly range of flights for each airport, providing insights into how flight numbers fluctuate over time. Additionally, we will use `geom_glyph_ribbon()` to visualize the variation between the minimum and maximum number of flights from each airport. 

```{r}
USmap <- us_map(regions = "state") |>
  filter(full != "Alaska")

# Specify tooltip for ggiraph 
flights <- flights |>
  mutate(tooltip = paste("origin: ",origin,
                         "\nmonth: ", month,
                         "\nmin_flights: ", min_flights,
                         "\nmax_flights: ", max_flights))

fl <- flights |> 
  ggplot(aes(x_major = long, y_major = lat,
             x_minor = month, y_minor = min_flights,
             yend_minor = max_flights,
             tooltip = tooltip)) + 
  geom_sf(data = USmap, color = "white",
          fill = "antiquewhite", inherit.aes = FALSE) +
  coord_sf(crs = st_crs(4326)) +
  add_glyph_boxes(color = "#CD5C08") +
  add_ref_lines(color = "#CD5C08") +
  geom_glyph_segment(color = "#CD5C08") +
  labs(title = "Monthly Flight Variability",
       subtitle = "Based on top 10 US Airports with high cancellations rate") +
  theme_glyph() 

# Interactive plot using ggiraph
girafe(ggobj = fl)
```

This plot displays the minimum and maximum number of flights departing from each airport on a spatial map. Each line segment represents the flight range for a respective airport. The length of each segment indicates the variability in flight numbers across different airports. Notably, airports like ATL and ORD generally have a higher volume of departing flights compared to others such as MCO and PHX. Additionally, all airports exhibit fluctuations throughout the year, with broader flight intervals mid-year and narrower intervals during the holiday season at year-end.

From the graph, it is evident that airports in certain regions experience more variability than others. While segment plots provide a good estimation of this variability, the geom_glyph_ribbon enhances our understanding by displaying the gap between minimum and maximum flights. Wider ribbons suggest greater fluctuation in flight operations month-to-month.

```{r, fig.height=6}
south <- us_map(include = .south_region)
west <- us_map(include = .west_region, exclude = c("AK", "HI"))

  
southR <- flights |> 
  filter(origin %in% c("ATL", "CLT", "MCO", "DFW")) |>
  ggplot(aes(x_major = long, y_major = lat,
             x_minor = month, ymin_minor = min_flights,
             ymax_minor = max_flights)) + 
  geom_sf(data = south, color = "white",
          fill = "antiquewhite", inherit.aes = FALSE) +
  coord_sf(crs = st_crs(4326)) +
  add_glyph_boxes(color = "#A6B37D") +
  add_ref_lines(color = "#A6B37D") +
  geom_glyph_ribbon(color = "#A6B37D", fill = "#A6B37D")  +
  labs(title = "South Region") +
  theme_glyph() 


westR <- flights |> 
  filter(origin %in% c("PHX", "LAS", "LAX", "SEA")) |>
  ggplot(aes(x_major = long, y_major = lat,
             x_minor = month, ymin_minor = min_flights,
             ymax_minor = max_flights)) + 
  geom_sf(data = west, color = "white",
          fill = "antiquewhite", inherit.aes = FALSE) +
  coord_sf(crs = st_crs(4326)) +
  add_glyph_boxes(color = "#CD5C08") +
  add_ref_lines(color = "#CD5C08") +
  geom_glyph_ribbon(color = "#CD5C08", fill = "#CD5C08")  +
  labs(title = "West Region") +
  theme_glyph() 

grid.arrange(westR, southR, ncol = 2)
```

`geom_glyph_ribbon()` highlights the disparities in flight volume between regions. The Western region exhibits a larger variation in the number of flights compared to the Southern region, as evidenced by the thicker ribbons. Interestingly, both regions show a notable increase in discrepancies during the mid-year, which supports our findings from the `geom_glyph_segment()`. 


```{r}
aus_temp |>
  mutate(month_fct = factor(case_when(month == 1 ~ "Jan",
                                      month == 2 ~ "Feb",
                                      month == 3 ~ "Mar",
                                      month == 4 ~ "Apr",
                                      month == 5 ~ "May",
                                      month == 6 ~ "Jun",
                                      month == 7 ~ "Jul",
                                      month == 8 ~ "Aug",
                                      month == 9 ~ "Sep",
                                      month == 10 ~ "Oct",
                                      month == 11 ~ "Nov",
                                      month == 12 ~ "Dec"),
                            levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))) |> 
  ggplot(aes(x_major = long, y_major = lat,
              x_minor = month_fct, ymin_minor = tmin, 
              ymax_minor = tmax)) +
  geom_sf(data = abs_ste, fill = "antiquewhite",
          inherit.aes = FALSE, color = "white") +
  geom_glyph_ribbon(width = 2.233387, height = 1.563371) +
  geom_rect(aes(xmin = 125, xmax = 127, ymin =  -13.1 , ymax = -14.1), color = "yellow", fill = NA, linewidth = 0.7)
```








